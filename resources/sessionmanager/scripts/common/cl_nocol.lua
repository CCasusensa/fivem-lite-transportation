-- No collision area handling
local NocolAreasDef = {
    {
        {name = "Elysian Island - Chupacabra St", x = -6.163710, y = -2566.351563, z = 6.150517, h = 186.552460}, -- glitchdetector (steam:1100001037e7ceb)
        {name = "Elysian Island - Chupacabra St", x = 25.313868, y = -2526.322754, z = 5.479256, h = 235.484741}, -- glitchdetector (steam:1100001037e7ceb)
        {name = "Elysian Island - Chupacabra St", x = 64.439629, y = -2538.680420, z = 5.520803, h = 264.827423}, -- glitchdetector (steam:1100001037e7ceb)
        {name = "Elysian Island - Chupacabra St", x = 106.367798, y = -2482.336426, z = 6.146632, h = 258.252625}, -- glitchdetector (steam:1100001037e7ceb)
        {name = "Elysian Island - Chupacabra St", x = -35.176735, y = -2383.024170, z = 5.999996, h = 7.180996}, -- glitchdetector (steam:1100001037e7ceb)
        {name = "Elysian Island - Chupacabra St", x = -280.886597, y = -2383.008545, z = 6.000633, h = 22.874987}, -- glitchdetector (steam:1100001037e7ceb)
        {name = "Elysian Island - Chupacabra St", x = -299.576324, y = -2404.744385, z = 6.138767, h = 127.187088}, -- glitchdetector (steam:1100001037e7ceb)
        {name = "Elysian Island - Chupacabra St", x = -206.304596, y = -2514.937012, z = 6.146294, h = 157.577133}, -- glitchdetector (steam:1100001037e7ceb)
        {name = "Elysian Island - Chupacabra St", x = -171.576111, y = -2515.441162, z = 6.017465, h = 169.973663}, -- glitchdetector (steam:1100001037e7ceb)
        {name = "Elysian Island - Chupacabra St", x = -110.249519, y = -2558.536377, z = 6.144917, h = 203.014847}, -- glitchdetector (steam:1100001037e7ceb)
    },
    {
        {name = "Paleto Bay - Paleto Blvd", x = 14.586551, y = 6531.605469, z = 31.451061, h = 133.893494}, -- glitchdetector
        {name = "Paleto Bay - Paleto Blvd", x = 14.684786, y = 6537.281250, z = 31.331499, h = 355.102783}, -- glitchdetector
        {name = "Paleto Bay - Paleto Blvd", x = 70.127548, y = 6592.739258, z = 31.493587, h = 338.912476}, -- glitchdetector
        {name = "Paleto Bay - Paleto Blvd", x = 79.288673, y = 6593.182129, z = 31.468296, h = 276.344360}, -- glitchdetector
        {name = "Paleto Bay - Paleto Blvd", x = 130.583313, y = 6542.183105, z = 31.338385, h = 242.627899}, -- glitchdetector
        {name = "Paleto Bay - Paleto Blvd", x = 126.622765, y = 6524.400879, z = 31.392761, h = 146.465668}, -- glitchdetector
        {name = "Paleto Bay - Paleto Blvd", x = 106.022110, y = 6506.171387, z = 31.340319, h = 144.109406}, -- glitchdetector
        {name = "Paleto Bay - Paleto Blvd", x = 72.873512, y = 6473.582031, z = 31.253700, h = 63.908348}, -- glitchdetector
    },
    {
        {name = "Paleto Bay - Great Ocean Hwy", x = 167.737976, y = 2729.737061, z = 43.164211, h = 74.074394}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 234.176727, y = 2740.937012, z = 43.148453, h = 249.601776}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 222.257080, y = 2810.303955, z = 45.648834, h = 327.248688}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 163.405045, y = 2801.313965, z = 43.887005, h = 256.082184}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 160.274567, y = 2779.597412, z = 43.766071, h = 195.528122}, -- glitchdetector
    },
    {
        {name = "Paleto Bay - Great Ocean Hwy", x = 3404.817139, y = 3642.701904, z = 41.535252, h = 120.083855}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 3410.662842, y = 3676.584717, z = 39.751907, h = 88.783752}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 3431.784424, y = 3748.817627, z = 30.924711, h = 68.066719}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 3420.897217, y = 3768.389893, z = 30.642553, h = 29.072025}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 3457.259277, y = 3785.511475, z = 30.518602, h = 70.299759}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 3464.451904, y = 3801.678223, z = 30.817657, h = 9.940866}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 3479.676758, y = 3813.810791, z = 30.878027, h = 336.425507}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 3502.159668, y = 3820.539551, z = 31.198095, h = 291.705414}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 3653.521484, y = 3834.935059, z = 30.312994, h = 24.958643}, -- glitchdetector
        {name = "Paleto Bay - Great Ocean Hwy", x = 3638.230713, y = 3591.879883, z = 51.919548, h = 60.777199}, -- glitchdetector
    },
    {
        {name = "Los Santos International Airport - New Empire Way", x = -863.924988, y = -2692.006836, z = 13.789835, h = 223.794327}, -- glitchdetector
        {name = "Los Santos International Airport - New Empire Way", x = -806.346985, y = -2725.782471, z = 13.944430, h = 215.107071}, -- glitchdetector
        {name = "Los Santos International Airport - New Empire Way", x = -761.481934, y = -2648.449219, z = 13.944619, h = 326.807922}, -- glitchdetector
        {name = "Los Santos International Airport - Exceptionalists Way", x = -719.800110, y = -2571.258301, z = 13.944387, h = 225.428787}, -- glitchdetector
        {name = "Los Santos International Airport - New Empire Way", x = -774.715210, y = -2538.747070, z = 13.946829, h = 239.004181}, -- glitchdetector
    },
    {
        {name = "North Chumash - Great Ocean Hwy", x = -2383.104248, y = 3409.986084, z = 32.974308, h = 354.171356}, -- glitchdetector
        {name = "Fort Zancudo - Great Ocean Hwy", x = -2277.604736, y = 3352.533691, z = 32.914204, h = 295.600647}, -- glitchdetector
        {name = "North Chumash - Great Ocean Hwy", x = -2304.166504, y = 3306.640625, z = 34.602928, h = 196.701202}, -- glitchdetector
        {name = "North Chumash - Great Ocean Hwy", x = -2331.486816, y = 3309.759033, z = 32.827927, h = 10.328413}, -- glitchdetector
        {name = "North Chumash - Great Ocean Hwy", x = -2411.698730, y = 3353.555420, z = 34.790905, h = 83.519997}, -- glitchdetector
        {name = "North Chumash - Great Ocean Hwy", x = -2413.766113, y = 3358.320313, z = 32.974331, h = 331.015381}, -- glitchdetector
    }
}

NocolAreas = {}

for _, def in pairs(NocolAreasDef) do
    local area = pArea({
        height = 6.0,
        numbered = true,
        label = def[1].name
    })
    for _, point in pairs(def) do
        area.addPoint(vector3(point.x, point.y, point.z - 3.0))
    end
    table.insert(NocolAreas, area)
end

NocolState = false

Citizen.CreateThread(function()
    while true do
        Wait(50)
        TickNoCollision(true)
    end
end)

Citizen.CreateThread(function()
    while true do
        Wait(100)
        local inArea = false
        for _, area in pairs(NocolAreas) do
            if area.isInside() then
                inArea = true
                AddFuel(1)
                break
            end
        end
        if inArea ~= NocolState then
            SetNoCollision(inArea)
        end
    end
end)

function _setNoCollision(bool)
    local ped = PlayerPedId()
    local entities = {}
    table.insert(entities, ped)
    if IsPedInAnyVehicle(ped, false) then
        local veh = GetVehiclePedIsIn(ped, false)
        table.insert(entities, veh)
        local hasTrailer, trailer = GetVehicleTrailerVehicle(veh)
        if hasTrailer then
            table.insert(entities, trailer)
        end
    end

    local function setCollisionStates(entity, col)
        if col then
            for _, ent in pairs(entities) do
                SetEntityNoCollisionEntity(entity, ent, 0)
            end
        else
            SetEntityCollision(entity, true, true)
        end
    end

    if not bool then
        for _, ent in pairs(entities) do
            SetEntityCollision(ent, true, true)
        end
    end

    local plys = GetNearbyPlayers()
    table.insert(plys, {id = PlayerId(), dist = 0.0})
    for _, player in next, plys do
        local ply = GetPlayerPed(player.id)
        setCollisionStates(ply, bool)
        local veh = GetVehiclePedIsIn(ply, false)
        if veh and veh ~= 0 then
            setCollisionStates(veh, bool)
            local hasTrailer, trailer = GetVehicleTrailerVehicle(veh)
            if hasTrailer then
                setCollisionStates(trailer, bool)
            end
        end
    end
end

function EnableNoCollision()
    NocolState = true
    -- _setNoCollision(NocolState)
    chat("You entered a service area")
end

function DisableNoCollision()
    NocolState = false
    -- _setNoCollision(NocolState)
    chat("You left the service area")
end

function TickNoCollision(bool)
    _setNoCollision(bool)
end

function SetNoCollision(bool)
    if bool then
        if not NocolState then EnableNoCollision() end
    else
        if NocolState then DisableNoCollision() end
    end
end
